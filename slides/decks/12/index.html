<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Lesson 12</title>

		<link rel="stylesheet" href="../../dist/reset.css">
		<link rel="stylesheet" href="../../dist/reveal.css">
		<link rel="stylesheet" href="../../dist/theme/black.css">
		<link rel="stylesheet" type="text/css" href="../../css/asciinema-player.css" />

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="../../plugin/highlight/github-dark.css">
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<section id="introduction">
						<h1>Persisting data with MongoDB</h1>
						<h3>Lesson 12</h3>
						<h4>SW4BED-01</h4>
					</section>
					<section>
						<h2>Agenda</h2>
					</section>
				</section>
				<section>
					<section>
						<h2>MongoDB</h2>
					</section>
					<section>
						<h2>Overview</h2>
						<ul>
							<li>Mongo is a NoSQL database
								<ul>
									<li>More specifically: A <mark>document</mark> database</li>
								</ul>
									<li><mark>Document</mark> Store data
										<ul>
											<li>Set of <mark>key-value</mark> pairs</li>
											<li>Documents are stored in <mark>collections</mark></li>
										</ul>
									</li>
									<li>Collections are <mark>organized</mark> stores of documents
										<ul>
											<li>usually with common fields</li>
										</ul>
									<li>Uses the <mark>JSON</mark> format when viewing and updating
										<ul>
											<li>Stores and transfers data in <mark>BSON</mark> format</li>
										</ul>
									</li>
								</ul>
							</li>
						</ul>
					</section>
					<section>
						<h2>MongoDB Driver</h2>
						<ul>
							<li>MongoDB provides an official C# driver</li>
							<li>Get the lastest version from NuGet
								<ul>
									<li>.NET CLI <code>dotnet add package MongoDB.Driver</code></li>
									<li>Package Manager <code>Install-Package MongoDB.Driver</code></li>
								</ul>
							</li>
							<li>There are also drivers for the most popular programming languages</li>
						</ul>
						<aside class="notes" aria-label="notes">
							<h4>References</h4>
							<ul>
								<li><a href="https://www.mongodb.com/docs/drivers/csharp/">MongoDB C#/.NET Driver — MongoDB Drivers</a></li>
							</ul>
						</aside>
					</section>
					<section>
						<h2>Setting up a connection</h2>
						<small><code>mongodb://[username:password@]host1[:port1][,...hostN[:portN]][/[defaultauthdb][?options]]</code></small>
						<ul>
							<li><code>mongodb://</code> Prefix to identify the string <sup>(required)</sup>	</li>
							<li><code>username@password@</code> Authentication credentials <sup>(optional)</sup></li>
							<li><code>host[:port]</code> Host and port for instance <sup>(host required, port optional (defaults to 27017))</sup></li>
							<li><code>/defaultauthdb</code> Database to use for authentication <sup>(optional)</sup></li>
							<li><code>?options</code> Query string for specific options in <code>&lt;name&gt;=&lt;name&gt;</code> format <sup>(optional)</sup></li>
						</ul>
						<aside class="notes" aria-label="notes">
							<h4>References</h4>
							<ul>
								<li><a href="https://www.mongodb.com/docs/manual/reference/connection-string/">Connection String URI Format — MongoDB Manual</a></li>
							</ul>
						</aside>
					</section>
					<section>
						<h2>Connecting to an instance</h2>
						<pre><code class="cs" data-line-numbers="|1-2|4|5|7|" data-trim data-noescape><script type="text/template">
							using MongoDB.Bson;
							using MongoDB.Driver;

							var client = new MongoClient(
								"mongodb://<username>:<password>@<host>:27017/test"
							);
							var database = client.GetDatabase("test");
						</script></code></pre>
						<small>Connect to MongoDB on local machine</small>
					</section>
					<section>
						<h2>Mapping classes</h2>
						<ul>
							<li>Using <code>BsonDocument</code> provides a fluid and dynamic shema
								<ul>
									<li>Usually there is an application scheme</li>
									<li>Application schemes are often implemented using POCOs</li>
								</ul>
							</li>
							<li>The .NET BSON library supports mapping to and from BSON/JSON 
								<ul>
									<li>The driver will map most class automatically</li>
									<li>Use <code>RegisterClassMap&lt;Clazz&gt;()</code> for special cases</li>
								</ul>
							</li>
						</ul>
						<aside class="notes" aria-label="notes">
							<h4>References</h4>
							<ul>
								<li><a href="https://mongodb.github.io/mongo-csharp-driver/2.15/reference/bson/mapping/">Mapping Classes</a></li>
							</ul>
						</aside>
					</section>
				</section>
				<section>
					<section>
						<h2>Creating documents</h2>
						<ul>
							<li>Use <code>InsertOne</code> or <code>InsertOneAsync</code> to insert a single document</li>
							<li>Use <code>InsertMany</code> or <code>InsertManyAsync</code> to insert multiple documents at once</li>
						</ul>
						<aside class="notes" aria-label="notes">
							<h4>References</h4>
							<ul>
								<li><a href="https://mongodb.github.io/mongo-csharp-driver/2.15/reference/driver/crud/writing/">Writing</a></li>
							</ul>
						</aside>
					</section>
					<section>
						<h2><code>InsertOne</code></h2>
						<pre><code class="cs" data-line-numbers="|11-14|25-27|" data-trim data-noescape><script type="text/template">
							using MongoDB.Driver;
							using mtg_collection.Models;

							namespace mtg_collection.Services;

							public class DeckService {

								private readonly ILogger<DeckService> _logger;
								private readonly IMongoCollection<Deck> _collection;
								
								public DeckService(ILogger<DeckService> logger, MongoService service) {
									_logger = logger;
									_collection = service.Client.GetDatabase("mtg").GetCollection<Deck>("decks");
								}

								public async Task<IList<Deck>> GetDecks(string? id) {
									var builder = Builders<Deck>.Filter;
									var filter = builder.Empty;
									if(id is not null) {
										filter &= builder.Eq(x => x.Id, id);
									}
									return await _collection.Find(filter).ToListAsync();
								}

								public async void CreateDeck(Deck deck) {
									await _collection.InsertOneAsync(deck);
								}
							}
						</script></code></pre>
						<small>examples/lesson-12-persisting-data-with-mongo-db/mtg-collection/Services/DeckService.cs</small>
					</section>
					<section>
						<h2><code>InsertMany</code></h2>
						<pre><code class="cs" data-line-numbers="|12-30|13|15|17-29|19|21-28|22,27|23-25|26|" data-trim data-noescape><script type="text/template">
							using MongoDB.Driver;
							using MongoDB.Bson.Serialization;
							using mtg_collection.Models;
							using System.Text.Json;
							
							namespace mtg_collection.Services;
							
							public class MongoService {
								
								private readonly MongoClient _client;

								public MongoService() {
									_client = new MongoClient("mongodb://root:example@localhost:27018");

									var db = _client.GetDatabase("mtg");

									if(_client.GetDatabase("mtg").ListCollections().ToList().Count == 0) {

											var collection = db.GetCollection<Card>("cards");

											foreach(var path in new [] { "lea.json", "arn.json", "atq.json", "leg.json" }) {
												using(var file = new StreamReader(path)) {
														var cards = JsonSerializer.Deserialize<List<Card>>(file.ReadToEnd(), new JsonSerializerOptions {
																PropertyNameCaseInsensitive = true
														});
														collection.InsertMany(cards);
												}
											}
									}
								}

								public MongoClient Client { 
									get {
										return _client;
									}
								}
							}
						</script></code></pre>
						<small>examples/lesson-12-persisting-data-with-mongo-db/mtg-collection/Services/MongoService.cs</small>
					</section>
				</section>
				<section>
					<section>
						<h2>Queries</h2>
					</section>
					<section>
						<h2>Overview</h2>
					</section>
					<section>
						<h2>Filtering</h2>
						<ul>
							<li>Filters are defined as <code>FilterDefinition&lt;TDocument&gt;</code> and can be defined in different ways:
								<ul>
									<li>JSON string: <code>"{ x: 1 }"</code></li>
									<li><code>BsonDocument</code>: <code>new BsonDocument("x", 1);</code></li>
									<li>Both renders to <code>{ x: 1 }</code></li>
								</ul>
							</li>
							<li>Provides a type-safe API
								<ul>
									<li>Helpful when building complex queries</li>
								</ul>
							</li>
							<li>The <code>&</code> (AND), <code>|</code> (OR), and <code>!</code> (NOT) operators are overloaded</li>
						</ul>
						<aside class="notes" aria-label="notes">
							<h4>References</h4>
							<ul>
								<li><a href="https://mongodb.github.io/mongo-csharp-driver/2.15/reference/driver/definitions/#filters">Definitions and Builders</a></li>
							</ul>
						</aside>
					</section>
					<section>
						<h2>Combine filters</h2>
						<pre><code class="cs" data-line-numbers="|14|18,35|19|20|22,24|23|26-28|30,32|31|34|" data-trim data-noescape><script type="text/template">
							using MongoDB.Bson;
							using MongoDB.Driver;
							
							namespace mtg_collection.Services;
							
							using mtg_collection.Models;
							
							public class CardService {
							
								private readonly ILogger<CardService> _logger;
								private readonly IMongoCollection<Card> _collection;

								public CardService(ILogger<CardService> logger, MongoService service) {
									_collection = service.Client.GetDatabase("mtg").GetCollection<Card>("cards");
									_logger = logger;
								}
							
								public async Task<IList<Card>> Search(string? name = null, string? type = null, string? set = null) {
									var builder = Builders<Card>.Filter;
									var filter = builder.Empty;

									if(name?.Length > 0) {
										filter &= builder.Regex(x => x.Name, new BsonRegularExpression($"/{name}/i"));
									}

									if(type?.Length > 0) {
										filter &= builder.Regex(x => x.Type, new BsonRegularExpression($"/{type}/i"));
									}

									if(set?.Length > 0) {
										filter &= builder.Eq(x => x.SetCode, set);
									}

									return await _collection.Find(filter).ToListAsync();
								}
							}
						</script></code></pre>
						<small>examples/lesson-12-persisting-data-with-mongo-db/mtg-collection/Services/CardService.cs</small>
					</section>
					<section>
						<h2>Sorting</h2>
						<ul>
							<li>The <code>SortDefinitionBuilder&lt;TDocument&gt;</code> renders sort documents
								<ul>
									<li>Provides a type-safe API for building MongoDB sort syntax</li>
								</ul>
							</li>
						</ul>
						<pre><code class="cs" data-line-numbers="|14|18,35|19|20|22,24|23|26-28|30,32|31|34|" data-trim data-noescape><script type="text/template">
							var builder = Builders<Widget>.Sort;
							
							var sort = builder.Ascending(x => x.X).Descending(x => x.Y);
							// or
							var sort = builder.Ascending("X").Descending("Y");
						</script></code></pre>
						<aside class="notes" aria-label="notes">
							<h4>References</h4>
							<ul>
								<li><a href="https://mongodb.github.io/mongo-csharp-driver/2.15/reference/driver/definitions/#sorts">Definitions and Builders</a></li>
							</ul>
						</aside>
					</section>
					<section>
						<h2>Projection</h2>
					</section>
					<section>
						<h2>LINQ</h2>
						<ul>
							<li><a href="https://mongodb.github.io/mongo-csharp-driver/2.15/reference/driver/crud/linq/">LINQ</a></li>
						</ul>
					</section>
				</section>
				<section>
					<section>
						<h2>Mutating documents</h2>
					</section>
					<section>
						<h2><code>FindAndModify</code> methods</h2>
						<ul>
							<li>Finds and performs an operation on a documents</li>
							<li>Available methods
								<ul>
									<li><code>FindOneAndDelete</code></li>
									<li><code>FindOneAndReplace</code></li>
									<li><code>FindOneAndUpdate</code></li>
								</ul>
							</li>
							<li>Returns either the original version or the new version
								<ul>
									<li>The original version is return as default</li>
									<li>Define <code>ReturnDocument</code> and other options in an options object
										<ul>
											<li><code>Projection</code> Format result using a <code>ProjectionDefinitionBuilder</code></li>
											<li><code>Sort</code> Since filtering could result in multiple selections, change the order by sorting</li>
											<li><code>IsUpsert</code> When replacing and updating, determine if a document is created if it does not exist</li>
										</ul>
									</li>
								</ul>
							</li>
						</ul>
						<aside class="notes" aria-label="notes">
							<h4>Reference</h4>
							<ul>
								<li><a href="https://mongodb.github.io/mongo-csharp-driver/2.15/reference/driver/crud/writing/#find-and-modify">Writing</a></li>
								<li><a href="https://www.mongodb.com/docs/manual/reference/command/findAndModify/">findAndModify — MongoDB Manual</a></li>
							</ul>
						</aside>
					</section>
					<section>
						<h2>Update</h2>
					</section>
					<section>
						<h2>Update operators</h2>
						<aside class="notes" aria-label="notes">
							<h4></h4>
							<ul>
								<li><a href="https://www.mongodb.com/docs/manual/reference/operator/update-field/">Field Update Operators — MongoDB Manual</a></li>
								<li><a href="https://mongodb.github.io/mongo-csharp-driver/2.15/getting_started/quick_tour/#updating-documents">Quick Tour</a></li>
							</ul>
						</aside>
					</section>
					<section>
						<h2>Deleting</h2>
						<aside class="notes" aria-label="notes">
							<h4>References</h4>
							<ul>
								<li><a href="https://mongodb.github.io/mongo-csharp-driver/2.15/getting_started/quick_tour/#deleting-documents">Quick Tour</a></li>
							</ul>
						</aside>
					</section>
				</section>
				<section>
					<section>
						<h2>GridFS</h2>
					</section>
					<section>
						<h2>Overview</h2>
						<ul>
							<li>GridFS is used for storing binary information
								<ul>
									<li>Maximum document size is 16 MB</li>
								</ul>
							</li>
							<li>Files are broken into chunks
								<ul>
									<li>Each chuck is individually uploaded</li>
									<li>Files are reassembled from chunks when downloaded</li>
								</ul>
							</li>
							<li>Files a stored in two collections
								<ul>
									<li><code>fs.files</code> Each file has entry that contains metadata</li>
									<li><code>fs.chunks</code> Each file has as many chunks as needed to store the file</li>
								</ul>
							</li>
						</ul>
						<aside class="notes" aria-label="notes">
							<h4>References</h4>
							<ul>
								<li><a href="https://mongodb.github.io/mongo-csharp-driver/2.15/reference/gridfs/">GridFS</a></li>
							</ul>
						</aside>
					</section>
				</section>
				<section>
					<h2>Wrap-up</h2>
				</section>
			</div>
		</div>

		<script src="../../dist/reveal.js"></script>
		<script src="../../plugin/notes/notes.js"></script>
		<script src="../../plugin/markdown/markdown.js"></script>
		<script src="../../plugin/highlight/highlight.js"></script>
		<script src="../../js/asciinema-player.js"></script>

		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,
				slideNumber: true,
				pdfSeparateFragments: false,
				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
			});
		</script>
	</body>
</html>
